<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Python-HTML image viewer client</title>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/screenfull.js/5.1.0/screenfull.min.js"
      integrity="sha512-SGPHIoS+NsP1NUL5RohNpDs44JlF36tXLN6H3Cw+EUyenEc5zPXWqfw9D+xmvR00QYUYewQIJQ6P5yH82Vw6Fg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script type="text/javascript">
      'use strict';
      const url = new URL(window.location.href);
      const targetUrl = url.searchParams.get('SocketUrl') ?? 'ws://localhost:9998';
      const startSocket = () => {
        let webSocket = new WebSocket(targetUrl);

        // webSocket.onopen = () =>
        //   (document.body.style.backgroundImage = 'url(waiting.png)');

        webSocket.onmessage = (message) => {
          // `message.data` is `url(data:image/***;base64,***)`
          // This code is vulnerable!
          document.body.style.backgroundImage = message.data;
          webSocket.send('rendered');
        };

        webSocket.onclose = () => {
          document.body.style.backgroundImage = 'url(waiting.png)';
          // Attempt to reconnect every 5 seconds.
          setTimeout(startSocket, 5000);
        };

        window.onbeforeunload = () => {
          // Disabling onclose handler first.
          webSocket.onclose = () => {};
          webSocket.close(1000, 'Window unloaded.');
        };
      };
      startSocket();
      if (screenfull.isEnabled) {
        document.onclick = () => screenfull.toggle();
      }
    </script>

    <style type="text/css">
      body {
        background-color: #000000;
        background-image: url('waiting.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center center;
      }
    </style>
  </head>
</html>
